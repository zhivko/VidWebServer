<html>
<head>
<title>Crypto chart for: {{ plot_data.title }} V&K</title>
<link rel="icon" href="static/favicon.ico">
</head>
<body>
<!--<h1>This is the Index page</h1>-->

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<div id="plot_div" style="width: 80%; height: 100%; float: left;"></div>
<div id="text_div" style="width: 20%; height: 100%; float: right;"></div>

<script type="text/javascript">

{% autoescape false %}
var krogci = {
		mode: 'markers',
	    type: 'scatter',
	    x: {{ plot_data.krogci_x }} ,
	    y: {{ plot_data.krogci_y }} ,
	    marker: { size: 12 },
        showlegend: true
	    
};
var trace1 = {
	    type: 'scatter',
	    x: {{ plot_data.x_axis }} ,
	    y: {{ plot_data.y_axis }} ,
	    name: '{{ plot_data.title }}',
        showlegend: true
	    
};
var traceVolume= {
        type:"bar",
        x: {{ plot_data.x_axis }},
        y: {{ plot_data.volume }},
        marker: { color: 'blue'},
        yaxis:"y2",
	    name: 'Volume',
        line:{width:2},
        showlegend: false
        
};
var shapes = {{ plot_data.lines }}
{% endautoescape %}

var layout = {
	shapes: shapes,
    title: "{{ plot_data.title }}",
    titlefont: {
            family: 'Poppins',
            size: 18,
            color: '#7f7f7f'
        },
    showlegend: true,
    autoscale: true,
    
    xaxis: {
        title: 'Time'
    },
    yaxis: {
    	autorange: true,
        title: 'USD$',
        type: 'linear'
    },
    yaxis2: {
    	visible: false,
    	showgrid: false,
        title: 'USD$',
        type: 'linear',
        overlaying: 'y',
        range: [0, (Math.max(...traceVolume.y)*5)],
        side: 'right'
    },
    margin: {
        l: 70,
        r: 40,
        b: 50,
        t: 50,
        pad: 4
    }
};
var data = [trace1, traceVolume, krogci];
var config = {
		  scrollZoom: true,
		  toImageButtonOptions: {
		    format: 'svg', // one of png, svg, jpeg, webp
		    filename: 'custom_image',
		    height: 500,
		    width: 700,
		    scale: 1, // Multiply title/legend/axis/canvas sizes by this factor
		    
		  },
		  editable: true,
		  modeBarButtonsToAdd: ["drawline"]
		  };


Plotly.newPlot("plot_div", data, layout, config);
var myplot= document.getElementById("plot_div");
var text_div= document.getElementById("text_div");
myplot.on('plotly_relayout', (event) => {
	console.log(event);
	
	var url = "/addLine";
	
	var http = new XMLHttpRequest();
	http.open("POST", url, true);
	http.setRequestHeader("Content-type", "application/json; charset=utf-8");
	http.onreadystatechange = function() {
	    if(http.readyState == 4 && http.status == 200) {
			text_div.innerHTML += "poslal crto na python server\n";
	    }
	}					

	
    if ('shapes' in event) {
        if (event["shapes"].length > 0) {
            console.log(event["shapes"].slice(-1));
            if(event["shapes"].slice(-1)[0].type=='line'){
					var esp=document.createElement("span");
					text_div.appendChild(esp);
					
					var x0 = event["shapes"].slice(-1)[0].x0;
					var x1 = event["shapes"].slice(-1)[0].x1;
					var y0 = event["shapes"].slice(-1)[0].y0;
					var y1 = event["shapes"].slice(-1)[0].y1;
					
					text_div.innerHTML += "x0:"+x0+" y0:"+y0+" x1:"+x1+" y1:"+y1 + "\n";
					
					
					const crta = {x0: x0, y0: y0, x1: x1, y1:y1};
					http.send(JSON.stringify(event["shapes"].slice(-1)[0]));
					
					//tole zbrise vse crte
					//Plotly.relayout(myplot, { shapes: [] });
           	}
            else
            {
            	window.alert("type: " + event["shapes"].slice(-1)[0].type);
            }
        }
    }
    else
    {
    	eventStr = JSON.stringify(event)
    	if(eventStr.includes("shapes[0]"))
    		http.send(eventStr);
    }
});

myplot.on('plotly_click',
	    function(data){
	      var point = data.points[0],
	          newAnnotation = {
	            x: point.xaxis.d2l(point.x),
	            y: point.yaxis.d2l(point.y),
	            arrowhead: 6,
	            ax: 0,
	            ay: -80,
	            bgcolor: 'rgba(255, 255, 255, 0.9)',
	            arrowcolor: point.fullData.marker.color,
	            font: {size:12},
	            bordercolor: point.fullData.marker.color,
	            borderwidth: 3,
	            borderpad: 4,
	            text: '<i>Series Identification</i><br>' + 
	                  '<b>Year</b>       '+(point.data.name) + '<br>' +
	                  '<i>Point Identification</i><br>' + 
	                  '<b>Month</b>      '+ (months[point.pointNumber]) + 
	                  '<br><i>Point Values</i><br>' +
	                  '<b>Time</b>     '+(point.x).toPrecision(4) +      
	                  '<br><b>Price</b>     '+(point.y).toPrecision(4) 
	                  
	        },
	        divid = document.getElementById('plot_div'),
	        newIndex = (divid.layout.annotations || []).length;
			console.log(point.pointNumber)
	     // delete instead if clicked twice
		  if(newIndex) {
	       var foundCopy = false;
	       divid.layout.annotations.forEach(function(ann, sameIndex) {
	         if(ann.text === newAnnotation.text ) {
	           Plotly.relayout('myDiv', 'annotations[' + sameIndex + ']', 'remove');
	           foundCopy = true;
	         }
	       });
	       if(foundCopy) return;
	     }
	     Plotly.relayout('myDiv', 'annotations[' + newIndex + ']', newAnnotation);
	  })  

</script>
</body>
</html>  